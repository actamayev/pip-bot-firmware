name: Build and Update Firmware

on:
  push:
    paths:
      - 'src/**'
      - 'platformio.ini'
      - 'partitions_custom.csv'
      - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug Git Info
        run: |
          echo "Current ref: ${{ github.ref }}"
          echo "Event name: ${{ github.event_name }}"
          echo "Base ref: ${{ github.base_ref }}"
          echo "Head ref: ${{ github.head_ref }}"
          git branch --show-current
          git rev-parse --abbrev-ref HEAD

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Set production environment
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Setting production environment"
          echo "BUILD_ENV=production" >> "$GITHUB_ENV"
          echo "S3_BUCKET=${{ secrets.PRODUCTION_S3_BUCKET }}" >> "$GITHUB_ENV"
          echo "API_ENDPOINT=${{ secrets.PRODUCTION_API_ENDPOINT }}" >> "$GITHUB_ENV"

      - name: Set staging environment
        if: github.ref == 'refs/heads/staging'
        run: |
          echo "Setting staging environment"
          echo "BUILD_ENV=staging" >> "$GITHUB_ENV"
          echo "S3_BUCKET=${{ secrets.STAGING_S3_BUCKET }}" >> "$GITHUB_ENV"
          echo "API_ENDPOINT=${{ secrets.STAGING_API_ENDPOINT }}" >> "$GITHUB_ENV"

      - name: Set local environment
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/staging'
        run: |
          echo "Setting local environment"
          echo "BUILD_ENV=local" >> "$GITHUB_ENV"
          echo "S3_BUCKET=${{ secrets.LOCAL_S3_BUCKET }}" >> "$GITHUB_ENV"

      - name: Confirm Environment
        run: echo "Selected environment is ${{ env.BUILD_ENV }}"

      - name: Build project
        run: platformio run --environment ${{ env.BUILD_ENV }}

      # Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Get the latest version number from S3
      - name: Get latest version number
        id: version
        run: |
          # List files in bucket and find the highest version number
          latest_version=$(aws s3 ls s3://${{ env.S3_BUCKET }}/ --recursive | grep -E "^.*[0-9]+\.bin$" | sed -E 's/.*\/([0-9]+)\.bin$/\1/' | sort -n | tail -n 1 || echo "0")
          
          # Increment the version number
          new_version=$((latest_version + 1))
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "New firmware version will be: $new_version"

      # Upload firmware to S3
      - name: Upload firmware to S3
        run: |
          # Locate the built firmware file (.bin)
          firmware_file=$(find .pio/build/${{ env.BUILD_ENV }} -name "firmware.bin")
          
          if [ -z "$firmware_file" ]; then
            echo "Error: Could not find firmware.bin file"
            exit 1
          fi
          
          # Upload to S3 with new naming format (just VERSION.bin)
          aws s3 cp $firmware_file s3://${{ env.S3_BUCKET }}/${{ steps.version.outputs.new_version }}.bin
          
          echo "Firmware uploaded to S3 bucket: ${{ env.S3_BUCKET }}/${{ steps.version.outputs.new_version }}.bin"

      # Notify server about new firmware
      - name: Notify server about new firmware
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
        run: |
          response=$(curl -X POST ${{ env.API_ENDPOINT }}/internal-routes/firmware-update \
            -H "Content-Type: application/json")
          
          echo "Response: $response"
          if echo "$response" | grep -q '"success":false'; then
            echo "Firmware update notification failed"
            exit 1
          fi
