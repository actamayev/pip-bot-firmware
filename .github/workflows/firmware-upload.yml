name: Upload Firmware to S3

on:
  push:
    branches:
      - main
      - staging
    paths:
      - 'src/**'
      - 'platformio.ini'
      - 'partitions_custom.csv'
      - '.github/workflows/firmware-upload.yml'

jobs:
  upload-to-s3:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set S3 Bucket Based on Branch
      id: set-s3-bucket
      run: |
        if [ "${{ github.ref_name }}" = "main" ]; then
          echo "bucket=${{ secrets.PRODUCTION_FIRMWARE_BUCKET }}" >> $GITHUB_ENV
        elif [ "${{ github.ref_name }}" = "staging" ]; then
          echo "bucket=${{ secrets.STAGING_FIRMWARE_BUCKET }}" >> $GITHUB_ENV
        else
          echo "Unsupported branch: ${{ github.ref_name }}"
          exit 1
        fi

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Create firmware bundle
      run: |
        # Create a temporary directory for the bundle
        mkdir -p firmware-bundle

        # Copy necessary files
        cp -r src firmware-bundle/
        cp platformio.ini firmware-bundle/
        cp partitions_custom.csv firmware-bundle/ || true

        # Create zip archive
        cd firmware-bundle
        zip -r ../firmware.zip ./*
        cd ..

    - name: Upload to S3
      run: |
        # Upload the main firmware bundle
        aws s3 cp firmware.zip "s3://${{ env.bucket }}/firmware/latest/firmware.zip"

        # Also upload with timestamp for versioning
        aws s3 cp firmware.zip "s3://${{ env.bucket }}/firmware/archives/firmware-$(date +%Y%m%d-%H%M%S).zip"

        echo "Uploaded firmware to:"
        echo "  - s3://${{ env.bucket }}/firmware/latest/firmware.zip"
        echo "  - s3://${{ env.bucket }}/firmware/archives/firmware-$(date +%Y%m%d-%H%M%S).zip"

    - name: Verify upload
      run: |
        # List the uploaded files to verify
        aws s3 ls "s3://${{ env.bucket }}/firmware/latest/"

        # Get object info to verify size and last modified
        aws s3api head-object --bucket ${{ env.bucket }} --key firmware/latest/firmware.zip

    - name: Cleanup
      run: |
        rm -rf firmware-bundle
        rm firmware.zip
